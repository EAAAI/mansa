<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الزيارات - ليالي الامتحان</title>
    <link rel="stylesheet" href="styles.css">
    <style>
    body {
        min-height: 100vh;
        background: linear-gradient(120deg, #00c6ff 0%, #38ef7d 50%, #ff6b6b 100%);
        background-attachment: fixed;
    }
    .dashboard-container {
        background: rgba(10,10,20,0.82);
        border-radius: 22px;
        box-shadow: 0 4px 32px 0 #0005;
        margin: 40px auto;
        max-width: 1200px;
        padding: 36px 20px 32px 20px;
        backdrop-filter: blur(8px);
        border: 1.5px solid rgba(255,255,255,0.10);
    }
    .dashboard-table th, .dashboard-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
        font-size: 1rem;
    }
    .dashboard-table th {
        background: linear-gradient(90deg, #00c6ff 0%, #38ef7d 50%, #ff6b6b 100%);
        color: #fff;
        font-weight: bold;
        border-top-right-radius: 10px;
        border-top-left-radius: 10px;
        border: none;
    }
    .dashboard-table tr:nth-child(even) { background: rgba(30,30,40,0.22); }
    .dashboard-table tr:nth-child(odd) { background: rgba(30,30,40,0.13); }
    .dashboard-table tr:hover { background: #e0f7fa99; }
    .stat-card {
        background: rgba(20,20,30,0.55);
        color: #fff;
        border-radius: 16px;
        padding: 22px 36px;
        text-align: center;
        flex: 1;
        min-width: 180px;
        box-shadow: 0 2px 12px #00c6ff22;
        border: 1.5px solid rgba(255,255,255,0.10);
        margin-bottom: 8px;
        transition: box-shadow 0.2s;
    }
    .stat-card:hover {
        box-shadow: 0 4px 24px #38ef7d44;
    }
    .stat-card .stat-value {
        font-size: 2.3rem;
        font-weight: bold;
        margin-bottom: 6px;
        color: #00c6ff;
        text-shadow: 0 2px 8px #0008;
    }
    .stat-card .stat-label {
        font-size: 1.13rem;
        letter-spacing: 0.5px;
        color: #eee;
    }
    h1 {
        background: linear-gradient(90deg, #00c6ff 0%, #38ef7d 50%, #ff6b6b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
        font-weight: bold;
        font-size: 2.3rem;
        margin-bottom: 24px;
    }
    </style>
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body style="background:#f7f7fa; font-family:'Cairo',sans-serif;">
    <div class="dashboard-container" style="max-width:900px;margin:40px auto;padding:32px;background:#fff;border-radius:18px;box-shadow:0 2px 16px #0001;">
        <h1 style="text-align:center;color:#38ef7d;margin-bottom:24px;">لوحة تحكم الزيارات</h1>
        <div id="stats" style="display:flex;gap:24px;justify-content:center;margin-bottom:32px;"></div>
        <div style="overflow-x:auto;">
            <table id="sessionsTable" class="dashboard-table" style="width:100%;border-collapse:collapse;">
                <thead>
                    <tr>
                        <th>الجلسة</th>
                        <th>الجهاز/المتصفح</th>
                        <th>النظام</th>
                        <th>الدولة</th>
                        <th>المدينة</th>
                        <th>المنطقة</th>
                        <th>المنظمة/الشبكة</th>
                        <th>اللغة</th>
                        <th>IP</th>
                        <th>الوقت</th>
                    </tr>
                </thead>
                <tbody id="sessionsBody"></tbody>
            </table>
        </div>
    </div>
    <script>
    // إعداد Firebase (نفس إعدادات الموقع)
    const firebaseConfig = {
        apiKey: "AIzaSyCFhUdOI9IqFCjBkg8zytanD5O1_67vCr4",
        authDomain: "manasa-ceaa2.firebaseapp.com",
        projectId: "manasa-ceaa2",
        storageBucket: "manasa-ceaa2.firebasestorage.app",
        messagingSenderId: "847284305108",
        appId: "1:847284305108:web:7a14698f76b3981c6acf41",
        measurementId: "G-CYX6QKJZSR"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // جلب بيانات الجلسات
    async function loadSessions() {
        const snapshot = await db.collection('sessions').orderBy('time', 'desc').limit(200).get();
        const sessions = [];
        snapshot.forEach(doc => sessions.push(doc.data()));
        renderStats(sessions);
        renderTable(sessions);
    }

    function renderStats(sessions) {
        const devices = new Set();
        const ips = new Set();
        const countries = new Set();
        const browsers = new Set();
        sessions.forEach(s => {
            devices.add(s.platform || 'غير معروف');
            if(s.ip) ips.add(s.ip);
            if(s.country) countries.add(s.country);
            // استخراج اسم المتصفح من userAgent
            if(s.userAgent) {
                let b = s.userAgent.match(/(Chrome|Firefox|Safari|Edge|Opera|MSIE|Trident)/);
                browsers.add(b ? b[0] : 'غير معروف');
            }
        });
        document.getElementById('stats').innerHTML = `
            <div class='stat-card'>
                <div class='stat-value'>${sessions.length}</div>
                <div class='stat-label'>عدد الجلسات</div>
            </div>
            <div class='stat-card'>
                <div class='stat-value'>${ips.size}</div>
                <div class='stat-label'>عدد الأجهزة/الآيبيهات</div>
            </div>
            <div class='stat-card'>
                <div class='stat-value'>${devices.size}</div>
                <div class='stat-label'>عدد أنظمة التشغيل</div>
            </div>
            <div class='stat-card'>
                <div class='stat-value'>${browsers.size}</div>
                <div class='stat-label'>عدد المتصفحات</div>
            </div>
            <div class='stat-card'>
                <div class='stat-value'>${countries.size}</div>
                <div class='stat-label'>عدد الدول</div>
            </div>
        `;
    }

    function renderTable(sessions) {
        const body = document.getElementById('sessionsBody');
        body.innerHTML = sessions.map(s => {
            // استخراج اسم المتصفح
            let browser = 'غير معروف';
            if(s.userAgent) {
                let b = s.userAgent.match(/(Chrome|Firefox|Safari|Edge|Opera|MSIE|Trident)/);
                browser = b ? b[0] : 'غير معروف';
            }
            return `<tr>
                <td style='font-size:.85rem;direction:ltr;'>${s.sessionId||''}</td>
                <td style='font-size:.85rem;'>${browser}<br><span style='color:#888;font-size:.8em;'>${(s.userAgent||'').split(')')[0]+')'}</span></td>
                <td style='font-size:.9rem;'>${s.platform||''}</td>
                <td>${s.country||''}</td>
                <td>${s.city||''}</td>
                <td>${s.region||''}</td>
                <td>${s.org||''}</td>
                <td>${s.language||''}</td>
                <td style='direction:ltr;'>${s.ip||''}</td>
                <td style='font-size:.9rem;'>${s.time?new Date(s.time).toLocaleString('ar-EG',{hour:'2-digit',minute:'2-digit',second:'2-digit',year:'numeric',month:'2-digit',day:'2-digit'}):'---'}</td>
            </tr>`;
        }).join('');
    }

    loadSessions();
    </script>
</body>
</html>
