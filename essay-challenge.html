<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ø¯ÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ - Ù„ÙŠØ§Ù„ÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Essay Challenge Specific Styles */
        .essay-challenge-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding-top: 80px;
        }

        .essay-challenge-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .essay-challenge-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .essay-challenge-header h1 {
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .essay-challenge-header h1 i {
            color: #38ef7d;
        }

        .essay-challenge-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
        }

        .back-btn {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #38ef7d, #11998e);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Cairo', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
        }

        /* Challenge Intro Section */
        .challenge-intro-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        .challenge-icon-big {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .challenge-intro-section h2 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 15px;
        }

        .challenge-intro-section p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .challenge-rules-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .rule-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .rule-card i {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .rule-card h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .rule-card p {
            color: #666;
            font-size: 0.95rem;
            margin: 0;
        }

        .challenger-name-input {
            margin: 30px auto;
            max-width: 400px;
        }

        .challenger-name-input label {
            display: block;
            color: #333;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .challenger-name-input input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 30px;
            font-size: 1.1rem;
            font-family: 'Cairo', sans-serif;
            text-align: center;
            transition: all 0.3s ease;
        }

        .challenger-name-input input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .start-challenge-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            padding: 18px 50px;
            border-radius: 30px;
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .start-challenge-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        /* Timer and Score Header */
        .challenge-status-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 80px;
            z-index: 50;
        }

        .timer-display {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .timer-display i {
            color: #667eea;
        }

        .timer-display.warning {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }

        .timer-display.warning i {
            color: #e74c3c;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #38ef7d, #11998e);
            color: #fff;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .progress-display {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-size: 1.1rem;
        }

        .progress-display i {
            color: #667eea;
        }

        /* Question Card */
        .essay-question-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .question-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
        }

        .question-marks {
            background: linear-gradient(135deg, #38ef7d, #11998e);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .question-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .question-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        /* Answer Input */
        .answer-section {
            margin-top: 20px;
        }

        .answer-label {
            display: block;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .answer-textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .answer-textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        /* Submit All Button */
        .submit-all-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: #fff;
            border: none;
            padding: 20px 50px;
            border-radius: 30px;
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 40px auto;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 400px;
        }

        .submit-all-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.4);
        }

        .submit-all-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* AI Feedback Section */
        .ai-feedback-section {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-right: 5px solid #667eea;
            display: none;
        }

        .ai-feedback-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .feedback-header i {
            color: #667eea;
            font-size: 1.5rem;
        }

        .feedback-header h4 {
            color: #333;
            margin: 0;
        }

        .feedback-score-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #38ef7d, #11998e);
            color: #fff;
            padding: 10px 25px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .feedback-content {
            color: #444;
            line-height: 2;
            white-space: pre-wrap;
        }

        .feedback-content strong {
            color: #667eea;
        }

        /* Loading Animation */
        .loading-feedback {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: #667eea;
        }

        .loading-feedback i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Result Section */
        .challenge-result-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .result-icon {
            font-size: 6rem;
            margin-bottom: 20px;
        }

        .result-title {
            color: #333;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .result-subtitle {
            color: #666;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-stat {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
        }

        .result-stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .result-stat-label {
            color: #666;
            font-size: 1rem;
        }

        .retry-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            padding: 18px 50px;
            border-radius: 30px;
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .essay-challenge-header h1 {
                font-size: 1.8rem;
            }

            .back-btn {
                top: 90px;
                right: 10px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .challenge-rules-grid,
            .result-stats {
                grid-template-columns: 1fr;
            }

            .challenge-status-bar {
                flex-direction: column;
                gap: 15px;
            }

            .essay-question-card {
                padding: 20px;
            }

            .question-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="essay-challenge-page">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-right"></i>
            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </a>

        <div class="essay-challenge-container">
            <div class="essay-challenge-header">
                <h1>
                    <i class="fas fa-pen-fancy"></i>
                    ØªØ­Ø¯ÙŠ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ
                </h1>
                <p>Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ© ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªØµØ­ÙŠØ­ ÙÙˆØ±ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
            </div>

            <!-- Challenge Intro -->
            <div class="challenge-intro-section" id="challengeIntro">
                <div class="challenge-icon-big">ğŸ“</div>
                <h2>ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠØ©</h2>
                <p>Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ 5 Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚Ø§Ù„ÙŠØ© ÙÙŠ 11 Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªØµØ­ÙŠØ­ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!</p>

                <div class="challenge-rules-grid">
                    <div class="rule-card">
                        <i class="fas fa-clock"></i>
                        <h4>11 Ø¯Ù‚ÙŠÙ‚Ø©</h4>
                        <p>ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠ</p>
                    </div>
                    <div class="rule-card">
                        <i class="fas fa-question-circle"></i>
                        <h4>5 Ø£Ø³Ø¦Ù„Ø©</h4>
                        <p>Ø£Ø³Ø¦Ù„Ø© Ù…Ù‚Ø§Ù„ÙŠØ©</p>
                    </div>
                    <div class="rule-card">
                        <i class="fas fa-star"></i>
                        <h4>30 Ø¯Ø±Ø¬Ø©</h4>
                        <p>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</p>
                    </div>
                </div>

                <div class="challenger-name-input">
                    <label><i class="fas fa-user"></i> Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø£Ø®ÙŠØ±)</label>
                    <input type="text" id="challengerName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" maxlength="50" required>
                    <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 8px;">âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ
                        Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠ</p>
                </div>

                <button class="start-challenge-btn" onclick="startEssayChallenge()">
                    <i class="fas fa-play"></i>
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ
                </button>
            </div>

            <!-- Challenge Active Section -->
            <div id="challengeActive" style="display: none;">
                <!-- Status Bar -->
                <div class="challenge-status-bar">
                    <div class="timer-display" id="timerDisplay">
                        <i class="fas fa-clock"></i>
                        <span id="timerText">11:00</span>
                    </div>
                    <div class="progress-display">
                        <i class="fas fa-list-ol"></i>
                        <span>5 Ø£Ø³Ø¦Ù„Ø©</span>
                    </div>
                    <div class="score-display">
                        <i class="fas fa-star"></i>
                        <span>30 Ø¯Ø±Ø¬Ø©</span>
                    </div>
                </div>

                <!-- Questions Container -->
                <div id="essayChallengeQuestions">
                    <!-- Questions will be loaded here dynamically -->
                </div>

                <!-- Submit All Button -->
                <button class="submit-all-btn" id="submitAllBtn" onclick="submitAllAnswers()">
                    <i class="fas fa-paper-plane"></i>
                    Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ ÙˆØªØµØ­ÙŠØ­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                </button>
            </div>

            <!-- Result Section -->
            <div class="challenge-result-section" id="challengeResult">
                <div class="result-icon" id="resultIcon">ğŸ†</div>
                <h2 class="result-title" id="resultTitle">Ø£Ø­Ø³Ù†Øª!</h2>
                <p class="result-subtitle" id="resultSubtitle">Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø¨Ù†Ø¬Ø§Ø­</p>

                <div class="result-stats">
                    <div class="result-stat">
                        <div class="result-stat-value" id="finalScore">0/30</div>
                        <div class="result-stat-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value" id="finalTime">00:00</div>
                        <div class="result-stat-label">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value" id="questionsAnswered">0/5</div>
                        <div class="result-stat-label">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©</div>
                    </div>
                </div>

                <button class="retry-btn" onclick="restartChallenge()">
                    <i class="fas fa-redo"></i>
                    Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Firebase Configuration
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCFhUdOI9IqFCjBkg8zytanD5O1_67vCr4",
            authDomain: "manasa-ceaa2.firebaseapp.com",
            projectId: "manasa-ceaa2",
            storageBucket: "manasa-ceaa2.firebasestorage.app",
            messagingSenderId: "847284305108",
            appId: "1:847284305108:web:7a14698f76b3981c6acf41",
            measurementId: "G-CYX6QKJZSR"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('âœ… Firebase initialized for Essay Challenge');
        } catch (error) {
            console.error('âŒ Firebase initialization error:', error);
        }

        // ==========================================
        // Configuration - Groq API
        // ==========================================
        const API_CONFIG = {
            apiKey: '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',
            apiUrl: 'https://api.groq.com/openai/v1/chat/completions',
            model: 'llama-3.3-70b-versatile'
        };

        // ==========================================
        // Challenge Configuration
        // ==========================================
        const CHALLENGE_TIME = 11 * 60; // 11 minutes in seconds
        const TOTAL_MARKS = 30;

        let challengerName = '';
        let participantIP = '';
        let participantData = null;
        let timerInterval = null;
        let timeRemaining = CHALLENGE_TIME;
        let challengeStartTime = null;
        let totalScore = 0;

        // ==========================================
        // Essay Questions Data
        // ==========================================
        const essayQuestionsData = [
            {
                id: 1,
                title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª | Q1: Definitions",
                marks: 6,
                description: "Ø¹Ø±Ù‘Ù Ø«Ù„Ø§Ø«Ø© Ù…Ù† Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: Ù…Ø¨Ø¯Ø£ Ù‡ÙŠØ¬Ù†Ø²ØŒ Ø§Ù„Ø­ÙŠÙˆØ¯ØŒ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¨ØŒ Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø²ØŒ ÙØ¬ÙˆØ© Ø§Ù„Ø·Ø§Ù‚Ø©",
                modelAnswer: `ğŸ”µ Ù…Ø¨Ø¯Ø£ Ù‡ÙŠØ¬Ù†Ø² (Huygens' Principle):
ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù„Ù‰ ØµØ¯Ø± Ø§Ù„Ù…ÙˆØ¬Ø© ÙŠÙ…ÙƒÙ† Ø§Ø¹ØªØ¨Ø§Ø±Ù‡Ø§ Ù…ØµØ¯Ø±Ø§Ù‹ Ù„Ù…ÙˆØ¬Ø§Øª Ø«Ø§Ù†ÙˆÙŠØ© ÙƒØ±ÙˆÙŠØ© ØªÙ†ØªØ´Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø¨Ù†ÙØ³ Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ù†ØªØ´Ø§Ø±.

ğŸ”µ Ø§Ù„Ø­ÙŠÙˆØ¯ (Diffraction):
Ù‡Ùˆ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ù…ÙˆØ¬Ø§Øª ÙˆØ§Ù†Ø­Ù†Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ù…Ø±ÙˆØ±Ù‡Ø§ Ø¹Ø¨Ø± ÙØªØ­Ø© Ø£Ùˆ Ø¹Ø§Ø¦Ù‚ Ø£Ø¨Ø¹Ø§Ø¯Ù‡ Ù…Ù‚Ø§Ø±Ø¨Ø© Ù„Ù„Ø·ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙŠ.

ğŸ”µ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¨ (Polarization):
Ù‡Ùˆ Ø®Ø§ØµÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„Ù…Ø³ØªØ¹Ø±Ø¶Ø©ØŒ ÙˆÙŠØ¹Ø¨Ø± Ø¹Ù† Ø§ØªØ¬Ø§Ù‡ Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙƒÙ‡Ø±Ø¨ÙŠ Ù„Ù„Ù…ÙˆØ¬Ø©.

ğŸ”µ Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø² (Barrier Potential):
Ù‡Ùˆ Ø§Ù„Ø¬Ù‡Ø¯ Ø§Ù„Ù…ØªÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø¬Ø§Ù†Ø¨ÙŠ Ø§Ù„ÙˆØµÙ„Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© (PN Junction) ÙˆØ§Ù„Ø°ÙŠ ÙŠÙ…Ù†Ø¹ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†Ø§Øª ÙˆØ§Ù„ÙØ¬ÙˆØ§Øª (0.7V Ù„Ù„Ø³ÙŠÙ„ÙŠÙƒÙˆÙ†).

ğŸ”µ ÙØ¬ÙˆØ© Ø§Ù„Ø·Ø§Ù‚Ø© (Band Gap):
Ù‡ÙŠ ÙØ±Ù‚ Ø§Ù„Ø·Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø­Ø²Ù…Ø© Ø§Ù„ØªÙƒØ§ÙØ¤ (Valence band) ÙˆØ­Ø²Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ (Conduction band).`
            },
            {
                id: 2,
                title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø­ÙŠÙˆØ¯ Ø§Ù„Ø´Ù‚ Ø§Ù„Ù…ÙØ±Ø¯ | Q2: Single Slit Diffraction",
                marks: 6,
                description: "Ø§Ø³ØªÙ†ØªØ¬ Ø±ÙŠØ§Ø¶ÙŠØ§Ù‹ Ø´Ø±Ø· Ø§Ù„Ù‡Ø¯Ø¨ Ø§Ù„Ù…Ø¸Ù„Ù… Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ ÙÙŠ Ø­ÙŠÙˆØ¯ Ø§Ù„Ø´Ù‚ Ø§Ù„Ù…ÙØ±Ø¯",
                modelAnswer: `ğŸ”µ Ø§Ù„Ù‡Ø¯Ø¨ Ø§Ù„Ù…Ø¸Ù„Ù… Ø§Ù„Ø£ÙˆÙ„ (First Dark Fringe):
1. Ù†Ù‚Ø³Ù… Ø§Ù„Ø´Ù‚ (Ø¹Ø±Ø¶Ù‡ a) Ø¥Ù„Ù‰ Ù…Ù†Ø·Ù‚ØªÙŠÙ† Ù…ØªØ³Ø§ÙˆÙŠØªÙŠÙ† (a/2)
2. Ù„ÙƒÙŠ ÙŠØ­Ø¯Ø« ØªØ¯Ø§Ø®Ù„ Ù‡Ø¯Ø§Ù…ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±Ù‚ Ø§Ù„Ù…Ø³Ø§Ø± Î»/2
3. Ù…Ù† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ: (a/2)sinÎ¸ = Î»/2
4. Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†: aÂ·sinÎ¸ = Î»

ğŸ”µ Ø§Ù„Ù‡Ø¯Ø¨ Ø§Ù„Ù…Ø¸Ù„Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ (Second Dark Fringe):
1. Ù†Ù‚Ø³Ù… Ø§Ù„Ø´Ù‚ Ø¥Ù„Ù‰ Ø£Ø±Ø¨Ø¹ Ù…Ù†Ø§Ø·Ù‚ Ù…ØªØ³Ø§ÙˆÙŠØ© (a/4)
2. ÙŠØ­Ø¯Ø« Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨ÙŠÙ† ÙƒÙ„ Ù…Ù†Ø·Ù‚ØªÙŠÙ† Ù…ØªØ¬Ø§ÙˆØ±ØªÙŠÙ†
3. Ù…Ù† Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ: (a/4)sinÎ¸ = Î»/2
4. Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†: aÂ·sinÎ¸ = 2Î»

ğŸ”µ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø¹Ø§Ù…Ø©: aÂ·sinÎ¸ = mÎ» (Ø­ÙŠØ« m = 1, 2, 3, ...)`
            },
            {
                id: 3,
                title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¨ | Q3: Polarization",
                marks: 6,
                description: "Ø§Ø´Ø±Ø­ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¨ Ø¨Ø§Ù„Ø§Ù…ØªØµØ§Øµ ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¨ Ø¨Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ Ù…Ø¹ Ø°ÙƒØ± Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†",
                modelAnswer: `ğŸ”µ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¨ Ø¨Ø§Ù„Ø§Ù…ØªØµØ§Øµ (Polarization by Absorption):
- Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø§Ø¯Ø© (Ù…Ø«Ù„ Ø§Ù„ØªÙˆØ±Ù…Ø§Ù„ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¨ÙˆÙ„Ø§Ø±ÙˆÙŠØ¯) ØªÙ…ØªØµ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø²ÙŠØ© Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø¨Ù„ÙˆØ±Ø©
- ØªØ³Ù…Ø­ Ø¨Ù†ÙØ§Ø° Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²Ø§Øª Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØ© Ø¹Ù„ÙŠÙ‡Ø§ ÙÙ‚Ø·
- Ù†Ø³ØªØ®Ø¯Ù… Ø´Ø±ÙŠØ­ØªÙŠÙ†: Ø§Ù„Ø£ÙˆÙ„Ù‰ (Polarizer) ÙˆØ§Ù„Ø«Ø§Ù†ÙŠØ© (Analyzer)
- Ù‚Ø§Ù†ÙˆÙ† Ù…Ø§Ù„ÙˆØ³: I = Imax Ã— cosÂ²Î¸

ğŸ”µ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¨ Ø¨Ø§Ù„Ø§Ù†Ø¹ÙƒØ§Ø³ (Polarization by Reflection):
- Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ³Ù‚Ø· Ø¶ÙˆØ¡ ØºÙŠØ± Ù…Ø³ØªÙ‚Ø·Ø¨ Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø¹Ù†Ø¯ Ø²Ø§ÙˆÙŠØ© Ø¨Ø±ÙˆØ³ØªØ± (Î¸p)
- ÙŠÙƒÙˆÙ† Ø§Ù„Ø´Ø¹Ø§Ø¹ Ø§Ù„Ù…Ù†Ø¹ÙƒØ³ Ù…Ø³ØªÙ‚Ø·Ø¨Ø§Ù‹ ÙƒÙ„ÙŠØ§Ù‹
- Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø´Ø¹Ø§Ø¹ Ø§Ù„Ù…Ù†Ø¹ÙƒØ³ ÙˆØ§Ù„Ù…Ù†ÙƒØ³Ø± ØªÙƒÙˆÙ† 90Â°
- Ù‚Ø§Ù†ÙˆÙ† Ø¨Ø±ÙˆØ³ØªØ±: tan(Î¸p) = nâ‚‚/nâ‚`
            },
            {
                id: 4,
                title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ | Q4: Magnetic Fields",
                marks: 6,
                description: "Ø§Ø³ØªÙ†ØªØ¬ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ Ù„Ø³Ù„Ùƒ Ù…Ø³ØªÙ‚ÙŠÙ… Ø·ÙˆÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† Ø¨ÙŠÙˆ-Ø³Ø§ÙØ§Ø±Øª",
                modelAnswer: `ğŸ”µ Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ Ù„Ø³Ù„Ùƒ Ù…Ø³ØªÙ‚ÙŠÙ… Ø·ÙˆÙŠÙ„:

1. Ù‚Ø§Ù†ÙˆÙ† Ø¨ÙŠÙˆ-Ø³Ø§ÙØ§Ø±Øª: dB = (Î¼â‚€I/4Ï€) Ã— (dl Ã— rÌ‚)/rÂ²

2. Ù„Ø³Ù„Ùƒ Ø·ÙˆÙŠÙ„ ÙŠÙ…Ø± Ø¨Ù‡ ØªÙŠØ§Ø± IØŒ Ù†Ø£Ø®Ø° Ø¹Ù†ØµØ± Ø·ÙˆÙ„ dl

3. Ù†ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø²Ø§ÙˆÙŠØ© Î¸ Ù…Ù† âˆ’Ï€/2 Ø¥Ù„Ù‰ +Ï€/2

4. Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: B = Î¼â‚€I / (2Ï€R)

Ø­ÙŠØ«:
- Î¼â‚€ = 4Ï€ Ã— 10â»â· TÂ·m/A (Ù†ÙØ§Ø°ÙŠØ© Ø§Ù„ÙØ±Ø§Øº)
- I = Ø§Ù„ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ù„Ùƒ
- R = Ø§Ù„Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ Ù…Ù† Ø§Ù„Ø³Ù„Ùƒ

ğŸ”µ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø¬Ø§Ù„: ÙŠÙØ­Ø¯Ø¯ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø¥ØµØ¨Ø¹ Ø§Ù„Ø¥Ø¨Ù‡Ø§Ù… ÙÙŠ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªÙŠØ§Ø±ØŒ Ø§Ù„Ø£ØµØ§Ø¨Ø¹ ØªÙ„ØªÙ ÙÙŠ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø¬Ø§Ù„)`
            },
            {
                id: 5,
                title: "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø®Ø§Ù…Ø³: Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¯Ø§ÙŠÙˆØ¯ | Q5: Diode Models",
                marks: 6,
                description: "Ø§Ø´Ø±Ø­ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ù„Ù„Ø¯Ø§ÙŠÙˆØ¯ (Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØŒ Ø§Ù„Ø¹Ù…Ù„ÙŠØŒ Ø§Ù„ÙƒØ§Ù…Ù„) Ù…Ø¹ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†",
                modelAnswer: `ğŸ”µ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ (Ideal Model):
â€¢ Ø§Ù†Ø­ÙŠØ§Ø² Ø£Ù…Ø§Ù…ÙŠ: Ù…ÙØªØ§Ø­ Ù…ØºÙ„Ù‚ (VF = 0)
â€¢ Ø§Ù†Ø­ÙŠØ§Ø² Ø¹ÙƒØ³ÙŠ: Ù…ÙØªØ§Ø­ Ù…ÙØªÙˆØ­ (I = 0)
â€¢ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ù‡Ø¯ Ù‡Ø¨ÙˆØ·

ğŸ”µ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠ (Practical Model):
â€¢ Ø§Ù†Ø­ÙŠØ§Ø² Ø£Ù…Ø§Ù…ÙŠ: Ù…ÙØªØ§Ø­ Ù…ØºÙ„Ù‚ + Ø¨Ø·Ø§Ø±ÙŠØ© 0.7V (Ù„Ù„Ø³ÙŠÙ„ÙŠÙƒÙˆÙ†)
â€¢ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†: IF = (Vbias âˆ’ 0.7) / R
â€¢ ÙŠØ±Ø§Ø¹ÙŠ Ø¬Ù‡Ø¯ Ø§Ù„Ø¹ØªØ¨Ø© ÙÙ‚Ø·

ğŸ”µ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙƒØ§Ù…Ù„ (Complete Model):
â€¢ ÙŠØ¶ÙŠÙ Ù…Ù‚Ø§ÙˆÙ…Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ØµØºÙŠØ±Ø© (r'd) ÙÙŠ Ø§Ù„Ø§Ù†Ø­ÙŠØ§Ø² Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ
â€¢ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†: IF = (Vbias âˆ’ 0.7) / (R + r'd)
â€¢ ÙŠØ±Ø§Ø¹ÙŠ Ø¬Ù‡Ø¯ Ø§Ù„Ø¹ØªØ¨Ø© ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©

Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù„Ø¬Ø±Ù…Ø§Ù†ÙŠÙˆÙ… VF = 0.3V Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 0.7V`
            }
        ];

        // ==========================================
        // Get Participant IP
        // ==========================================
        async function getParticipantIP() {
            return {
                ip: 'hidden',
                country: 'hidden',
                city: 'hidden',
                region: 'hidden'
            };
        }

        // ==========================================
        // Validate Name (must be real name with first and last)
        // ==========================================
        function validateName(name) {
            // Remove extra spaces
            const cleanName = name.trim().replace(/\s+/g, ' ');

            // Must have at least 2 parts (first and last name)
            const parts = cleanName.split(' ');
            if (parts.length < 2) {
                return { valid: false, message: 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø£Ø®ÙŠØ±' };
            }

            // Each part must be at least 2 characters
            for (const part of parts) {
                if (part.length < 2) {
                    return { valid: false, message: 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙƒÙ„ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø­Ø±ÙÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' };
                }
            }

            // Must be at least 5 characters total
            if (cleanName.length < 5) {
                return { valid: false, message: 'Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹' };
            }

            // Check for invalid characters (numbers, special chars)
            if (/[0-9!@#$%^&*()_+=\[\]{}|;:'"<>,.?/\\]/.test(cleanName)) {
                return { valid: false, message: 'Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±ÙˆÙ ÙÙ‚Ø·' };
            }

            return { valid: true, name: cleanName };
        }

        // ==========================================
        // Register Participant in Firebase
        // ==========================================
        async function registerParticipant(name, ipData) {
            if (!db) return null;

            try {
                const participantData = {
                    name: name,
                    ip: ipData.ip,
                    country: ipData.country,
                    city: ipData.city,
                    region: ipData.region,
                    userAgent: navigator.userAgent,
                    isMobile: /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent),
                    startTime: firebase.firestore.FieldValue.serverTimestamp(),
                    startTimeLocal: new Date().toISOString(),
                    date: new Date().toLocaleDateString('ar-EG'),
                    status: 'started',
                    score: null,
                    timeTaken: null
                };

                const docRef = await db.collection('essay_challenge_participants').add(participantData);
                console.log('âœ… Participant registered:', docRef.id);
                return { id: docRef.id, ...participantData };
            } catch (error) {
                console.error('âŒ Error registering participant:', error);
                return null;
            }
        }

        // ==========================================
        // Update Participant Result
        // ==========================================
        async function updateParticipantResult(participantId, score, timeTaken, answers) {
            if (!db || !participantId) return;

            try {
                await db.collection('essay_challenge_participants').doc(participantId).update({
                    status: 'completed',
                    score: score,
                    timeTaken: timeTaken,
                    endTime: firebase.firestore.FieldValue.serverTimestamp(),
                    answers: answers
                });
                console.log('âœ… Participant result updated');
            } catch (error) {
                console.error('âŒ Error updating participant result:', error);
            }
        }

        // ==========================================
        // Start Challenge
        // ==========================================
        async function startEssayChallenge() {
            const nameInput = document.getElementById('challengerName');
            const startBtn = document.querySelector('.start-challenge-btn');

            const rawName = nameInput.value;

            // Validate name
            const validation = validateName(rawName);
            if (!validation.valid) {
                alert('âš ï¸ ' + validation.message + '\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø£Ø®ÙŠØ±)');
                nameInput.focus();
                return;
            }

            challengerName = validation.name;

            // Show loading
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';

            // Get IP and register participant
            const ipData = await getParticipantIP();
            participantIP = ipData.ip;

            participantData = await registerParticipant(challengerName, ipData);

            // Hide intro, show challenge
            document.getElementById('challengeIntro').style.display = 'none';
            document.getElementById('challengeActive').style.display = 'block';

            // Reset variables
            timeRemaining = CHALLENGE_TIME;
            challengeStartTime = Date.now();
            totalScore = 0;

            // Load questions
            loadChallengeQuestions();

            // Start timer
            startTimer();

            // Reset button
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ';
        }

        // ==========================================
        // Load Questions
        // ==========================================
        function loadChallengeQuestions() {
            const container = document.getElementById('essayChallengeQuestions');

            container.innerHTML = essayQuestionsData.map((q, index) => `
                <div class="essay-question-card" id="question-${q.id}">
                    <div class="question-header">
                        <span class="question-number">Ø³Ø¤Ø§Ù„ ${index + 1}</span>
                        <span class="question-marks"><i class="fas fa-star"></i> ${q.marks} Ø¯Ø±Ø¬Ø§Øª</span>
                    </div>
                    
                    <h3 class="question-title">${q.title}</h3>
                    <p class="question-description">${q.description}</p>
                    
                    <div class="answer-section">
                        <label class="answer-label">
                            <i class="fas fa-edit"></i> Ø¥Ø¬Ø§Ø¨ØªÙƒ:
                        </label>
                        <textarea 
                            class="answer-textarea" 
                            id="answer-${q.id}" 
                            placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§ Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."
                        ></textarea>
                    </div>
                    
                    <div class="ai-feedback-section" id="feedback-${q.id}">
                        <!-- AI Feedback will appear here -->
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // Timer Functions
        // ==========================================
        function startTimer() {
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitAllAnswers();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerText = document.getElementById('timerText');
            const timerDisplay = document.getElementById('timerDisplay');

            timerText.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Warning when less than 2 minutes
            if (timeRemaining <= 120) {
                timerDisplay.classList.add('warning');
            }
        }

        // ==========================================
        // Submit All Answers
        // ==========================================
        async function submitAllAnswers() {
            // Stop timer
            clearInterval(timerInterval);

            // Disable submit button
            const submitBtn = document.getElementById('submitAllBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ­ÙŠØ­...';

            // Calculate time taken
            const timeTaken = CHALLENGE_TIME - timeRemaining;
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Collect answers and grade each one
            let totalScore = 0;
            let answeredCount = 0;
            const questionScores = [];

            for (const question of essayQuestionsData) {
                const answerTextarea = document.getElementById(`answer-${question.id}`);
                const feedbackSection = document.getElementById(`feedback-${question.id}`);
                const answer = answerTextarea.value.trim();

                if (answer) {
                    answeredCount++;
                    feedbackSection.classList.add('show');
                    feedbackSection.innerHTML = `
                        <div class="loading-feedback">
                            <i class="fas fa-spinner"></i>
                            <span>Ø¬Ø§Ø±ÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø³Ø¤Ø§Ù„ ${question.id}...</span>
                        </div>
                    `;

                    try {
                        const result = await getAIGrade(question, answer);
                        totalScore += result.score;
                        questionScores.push({ id: question.id, score: result.score, maxScore: question.marks });

                        feedbackSection.innerHTML = `
                            <div class="feedback-header">
                                <i class="fas fa-robot"></i>
                                <h4>ØªÙ‚ÙŠÙŠÙ… Ø°ÙƒÙŠ</h4>
                            </div>
                            <div class="feedback-score-badge">
                                <i class="fas fa-star"></i>
                                ${result.score} / ${question.marks} Ø¯Ø±Ø¬Ø©
                            </div>
                            <div class="feedback-content">${result.feedback}</div>
                        `;
                    } catch (error) {
                        console.error('AI Grading Error:', error);
                        feedbackSection.innerHTML = `
                            <div class="feedback-header">
                                <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                                <h4>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ­ÙŠØ­</h4>
                            </div>
                            <div class="feedback-content">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØµØ­ÙŠØ­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„.</div>
                        `;
                    }
                } else {
                    feedbackSection.classList.add('show');
                    feedbackSection.innerHTML = `
                        <div class="feedback-header">
                            <i class="fas fa-times-circle" style="color: #e74c3c;"></i>
                            <h4>Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h4>
                        </div>
                        <div class="feedback-score-badge" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                            <i class="fas fa-star"></i>
                            0 / ${question.marks} Ø¯Ø±Ø¬Ø©
                        </div>
                    `;
                }
            }

            // Collect all answers for saving
            const answersData = essayQuestionsData.map(q => {
                const answerTextarea = document.getElementById(`answer-${q.id}`);
                return {
                    questionId: q.id,
                    questionTitle: q.title,
                    answer: answerTextarea.value.trim(),
                    maxMarks: q.marks
                };
            });

            // Save results to Firebase
            if (participantData && participantData.id) {
                await updateParticipantResult(participantData.id, totalScore, timeString, answersData);
            }

            // Show result
            showResult(totalScore, timeString, answeredCount);
        }

        // ==========================================
        // Get AI Grade
        // ==========================================
        async function getAIGrade(question, studentAnswer) {
            const systemPrompt = `Ø£Ù†Øª Ù…ØµØ­Ø­ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø°ÙƒÙŠ. Ù…Ù‡Ù…ØªÙƒ ØªØµØ­ÙŠØ­ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ¥Ø¹Ø·Ø§Ø¡ Ø¯Ø±Ø¬Ø© Ø¯Ù‚ÙŠÙ‚Ø©.

Ø§Ù„Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹:
1. Ø£Ø¹Ø·Ù Ø¯Ø±Ø¬Ø© Ø±Ù‚Ù…ÙŠØ© Ù…Ù† ${question.marks} (Ù…Ø«Ø§Ù„: 4.5 Ø£Ùˆ 5 Ø£Ùˆ 3)
2. Ø§Ø¨Ø¯Ø£ Ø±Ø¯Ùƒ Ø¨Ù€ "Ø§Ù„Ø¯Ø±Ø¬Ø©: X/${question.marks}" Ø­ÙŠØ« X Ù‡ÙŠ Ø§Ù„Ø¯Ø±Ø¬Ø©
3. Ø«Ù… Ø§Ø´Ø±Ø­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…

ÙƒÙ† Ø¹Ø§Ø¯Ù„Ø§Ù‹ ÙˆØ¯Ù‚ÙŠÙ‚Ø§Ù‹ ÙÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….`;

            const userPrompt = `Ø§Ù„Ø³Ø¤Ø§Ù„: ${question.title}
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${question.description}
Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©: ${question.marks} Ø¯Ø±Ø¬Ø§Øª

Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:
${question.modelAnswer}

Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:
${studentAnswer}

Ù…Ù† ÙØ¶Ù„Ùƒ ØµØ­Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ£Ø¹Ø·Ù Ø§Ù„Ø¯Ø±Ø¬Ø©.`;

            const response = await fetch(API_CONFIG.apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: API_CONFIG.model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    max_tokens: 1500,
                    temperature: 0.2
                })
            });

            if (!response.ok) {
                throw new Error('API Error');
            }

            const data = await response.json();
            const feedback = data.choices[0]?.message?.content || '';

            // Extract score from response
            let score = 0;
            const scoreMatch = feedback.match(/Ø§Ù„Ø¯Ø±Ø¬Ø©:\s*(\d+\.?\d*)/);
            if (scoreMatch) {
                score = Math.min(parseFloat(scoreMatch[1]), question.marks);
            }

            // Format the feedback
            const formattedFeedback = feedback
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            return { score, feedback: formattedFeedback };
        }

        // ==========================================
        // Show Result
        // ==========================================
        function showResult(score, time, answered) {
            document.getElementById('challengeActive').style.display = 'none';
            document.getElementById('challengeResult').style.display = 'block';

            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultSubtitle = document.getElementById('resultSubtitle');

            // Determine result message based on score
            const percentage = (score / TOTAL_MARKS) * 100;

            if (percentage >= 90) {
                resultIcon.textContent = 'ğŸ†';
                resultTitle.textContent = 'Ù…Ù…ØªØ§Ø²! Ø£Ù†Øª Ø¨Ø·Ù„!';
                resultSubtitle.textContent = `${challengerName}ØŒ Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹!`;
            } else if (percentage >= 75) {
                resultIcon.textContent = 'ğŸŒŸ';
                resultTitle.textContent = 'Ø£Ø­Ø³Ù†Øª!';
                resultSubtitle.textContent = `${challengerName}ØŒ Ù†ØªÙŠØ¬Ø© Ø¬ÙŠØ¯Ø© Ø¬Ø¯Ø§Ù‹!`;
            } else if (percentage >= 60) {
                resultIcon.textContent = 'ğŸ‘';
                resultTitle.textContent = 'Ø¬ÙŠØ¯!';
                resultSubtitle.textContent = `${challengerName}ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ­Ø³Ù†!`;
            } else if (percentage >= 40) {
                resultIcon.textContent = 'ğŸ’ª';
                resultTitle.textContent = 'Ù„Ø§ Ø¨Ø£Ø³!';
                resultSubtitle.textContent = `${challengerName}ØŒ ØªØ­ØªØ§Ø¬ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©`;
            } else {
                resultIcon.textContent = 'ğŸ“š';
                resultTitle.textContent = 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!';
                resultSubtitle.textContent = `${challengerName}ØŒ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹`;
            }

            document.getElementById('finalScore').textContent = `${score.toFixed(1)}/${TOTAL_MARKS}`;
            document.getElementById('finalTime').textContent = time;
            document.getElementById('questionsAnswered').textContent = `${answered}/5`;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // Restart Challenge
        // ==========================================
        function restartChallenge() {
            document.getElementById('challengeResult').style.display = 'none';
            document.getElementById('challengeIntro').style.display = 'block';

            // Reset timer display
            document.getElementById('timerText').textContent = '11:00';
            document.getElementById('timerDisplay').classList.remove('warning');

            // Clear name input
            document.getElementById('challengerName').value = '';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>

</html>
